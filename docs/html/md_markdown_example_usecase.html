<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WaSH Docs: Example Simulation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">WaSH Docs
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Example Simulation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>WaSH allows for arbitrary orderings of kernel functions in order to simulate a large variety of SPH scenarios.</p>
<p>This page describes how one can use WaSH to create a basic water simulation. A finished version of this example may be found in the WaSH source code as the <code>ca_fluid_sim</code> example.</p>
<h1>Constants</h1>
<p>Some constants are defined before starting the simulation for easy parameter tweaking. Here's what constants should be defined at the top: </p><div class="fragment"><div class="line">constexpr <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#a57d93ce8b44133ed956acc10a45e6223">spawnCentre</a> { 3.35, 0.51 };</div><div class="line">constexpr <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#ab15a76f258cadefcad1f4b39a8e76618">initialVelocity</a> { 0.0, 0.0 };</div><div class="line">constexpr <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#ab17b2a069e81c771262e861e014202d0">spawnSize</a> { 7.0, 7.0 };</div><div class="line">constexpr <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#ae3c8d23dc2c71306f6366b252c3ffb18">boundsSize</a> { 17.1, 9.3 };</div><div class="line"></div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#a39140666db6cb0c2fa813506654e739b">jitterStr</a> = 0.025;</div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#adfee095e4b276ab10960391284f14410">numParticles</a> = 4032;</div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#af81f980bddb2471a968025ae3a738fa9">gravity</a> = -12.0;</div><div class="line"></div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a78e0adba8d27825f587ec87ed578015f">deltaTime</a> = <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#a7ae2a6045aeb799eb72e4ee4d6015ac1">TIME_DELTA</a>(1, 3);</div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#ab103ceb8127270461e6653cc3a770182">collisionDamping</a> = 0.95;</div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#aeb9760a781fb6ccf134ed4353c9888e5">smoothingRadius</a> = 0.35;</div><div class="line"></div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a8df34bc56a46bc3a73024f988bac3271">targetDensity</a> = 55.0;</div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a4a61cd5f68fcbc416bd3904622ab80fc">pressureMultiplier</a> = 500.0;</div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a7e14d37dda2b744892950a0a7a3c913a">nearPressureMultiplier</a> = 18.0;</div><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a0f2e430964cc73edbaf77b1e4eeb2136">viscosityStrength</a> = 0.06;</div></div><!-- fragment --><h1>Initialising Common Parameters</h1>
<p>The first step is to set some parameters for your simulation.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div><div class="line">    wash::set_precision(<span class="stringliteral">&quot;double&quot;</span>);</div><div class="line">    wash::set_influence_radius(<a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#aeb9760a781fb6ccf134ed4353c9888e5">smoothingRadius</a>);</div><div class="line">    <a class="code" href="namespacewash.html#aeb7b287406244c8ab192d0524ad4da5b">wash::set_max_iterations</a>(1000);</div><div class="line">}</div></div><!-- fragment --><h1>Outputs</h1>
<p>The simulation results must be written <em>somewhere</em>. WaSH provides API calls for specifying what file to output to: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">if</span> (argc &gt; 1) {</div><div class="line">        <span class="comment">// argv[1] = simulation name</span></div><div class="line">        <a class="code" href="namespacewash.html#a4ddbab848bef96e0fc69bf8e280d4775">wash::set_simulation_name</a>(argv[1]);</div><div class="line">        <span class="keywordflow">if</span> (argc &gt; 2) {</div><div class="line">            <span class="comment">// argv[2] = output file name</span></div><div class="line">            <a class="code" href="namespacewash.html#ad6de17b9a27f58f6245a68ede303e84b">wash::set_output_file_name</a>(argv[2]);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            <a class="code" href="namespacewash.html#ad6de17b9a27f58f6245a68ede303e84b">wash::set_output_file_name</a>(<span class="stringliteral">&quot;ca&quot;</span>);</div><div class="line">        }</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <a class="code" href="namespacewash.html#a4ddbab848bef96e0fc69bf8e280d4775">wash::set_simulation_name</a>(<span class="stringliteral">&quot;serial_test&quot;</span>);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h1>Forces</h1>
<p>A 'Force' in this case is not necessarily a force, but could be a particle's <em>property</em> for example temperature, that some other simulations may want to use for their calculations. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div><div class="line">    ...</div><div class="line">    wash::add_force(<span class="stringliteral">&quot;nearDensity&quot;</span>, 1);</div><div class="line"></div><div class="line">    wash::add_force(<span class="stringliteral">&quot;predictedPosition&quot;</span>, 2);</div><div class="line">    wash::add_force(<span class="stringliteral">&quot;pressure&quot;</span>, 2);</div><div class="line">}</div></div><!-- fragment --><p> These forces are now tracked for each particle in the simulation and may be used within kernel functions.</p>
<h1>Kernels</h1>
<p>The kernels that describe the specific computations to take place in the simulation must be registered with WaSH.</p>
<h2>Initialisation Kernel</h2>
<p>Your simulation must have a starting state for your particles. This is done like so: </p><div class="fragment"><div class="line">wash::add_init_kernel(&amp;<a class="code" href="init_8cpp.html#a9961f7ff0de6fe6ea7838db3950e534f">init</a>);</div></div><!-- fragment --><p> When the simulation starts, it will use whatever is defined in the <code>init</code> function. The contents of the <code>init</code> function may look like this if your goal is to spawn uniformly distributed particles: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="init_8cpp.html#a9961f7ff0de6fe6ea7838db3950e534f">init</a>() {</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Calculated Time Step: &quot;</span> &lt;&lt; <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a78e0adba8d27825f587ec87ed578015f">deltaTime</a> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    SpawnParticles(<a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#ab17b2a069e81c771262e861e014202d0">spawnSize</a>, <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#adfee095e4b276ab10960391284f14410">numParticles</a>);</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line"><span class="keywordtype">void</span> SpawnParticles(<span class="keyword">const</span> <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> spawnSizeVec, <span class="keyword">const</span> <span class="keywordtype">size_t</span> particleCount) {</div><div class="line">    std::uniform_real_distribution&lt;double&gt; <a class="code" href="vector__test_8cpp.html#a3757a8b93144971a314801d61dccfdcb">unif</a>(0.0, 1.0);</div><div class="line">    std::default_random_engine <a class="code" href="vector__test_8cpp.html#a2ee18289ce89962484f3b5227d11faf6">re</a>(42);</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> s_x = spawnSizeVec.<a class="code" href="classwash_1_1Vec.html#a1be26013b6d4f898b8504fc258043400">at</a>(0);</div><div class="line">    <span class="keywordtype">double</span> s_y = spawnSizeVec.<a class="code" href="classwash_1_1Vec.html#a1be26013b6d4f898b8504fc258043400">at</a>(1);</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> numX = (<a class="code" href="namespacecompare__solutions.html#a73d633d24717b7bdfb5ba69fd060eabc">int</a>)std::ceil( <a class="code" href="namespacewash.html#aa7c01695ae3be583edc0ed8c4bd756f5">std::sqrt</a>(</div><div class="line">        s_x / s_y * particleCount + (s_x - s_y) * (s_x - s_y) / (4 * s_y * s_y)</div><div class="line">    ) - (s_x - s_y) / (2 * s_y));</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> numY = (<a class="code" href="namespacecompare__solutions.html#a73d633d24717b7bdfb5ba69fd060eabc">int</a>)std::ceil( (<span class="keywordtype">double</span>)particleCount / (double)numX );</div><div class="line">    <span class="keywordtype">int</span> i = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; numY; y++) {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; numX; x++) {</div><div class="line">            <span class="keywordflow">if</span> (i &gt;= particleCount) <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">            <span class="keywordtype">double</span> tx = numX &lt;= 1 ? 0.5 : x / (numX - 1.0);</div><div class="line">            <span class="keywordtype">double</span> ty = numY &lt;= 1 ? 0.5 : y / (numY - 1.0);</div><div class="line"></div><div class="line">            <span class="keywordtype">double</span> angle = <a class="code" href="vector__test_8cpp.html#a3757a8b93144971a314801d61dccfdcb">unif</a>(<a class="code" href="vector__test_8cpp.html#a2ee18289ce89962484f3b5227d11faf6">re</a>) * <a class="code" href="3d__fluid__sim_2fluid__sim_8hpp.html#a598a3330b3c21701223ee0ca14316eca">PI</a> * 2.0;</div><div class="line">            <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> dir = <a class="code" href="namespacewash.html#a905f2d902fc7aaab0e8a58b6ee25baf1">wash::Vec2D</a>({ std::cos(angle), std::sin(angle) });</div><div class="line">            <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> jitter = dir * <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#a39140666db6cb0c2fa813506654e739b">jitterStr</a> * (<a class="code" href="vector__test_8cpp.html#a3757a8b93144971a314801d61dccfdcb">unif</a>(<a class="code" href="vector__test_8cpp.html#a2ee18289ce89962484f3b5227d11faf6">re</a>) - 0.5);</div><div class="line">            <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> pos = <a class="code" href="namespacewash.html#a905f2d902fc7aaab0e8a58b6ee25baf1">wash::Vec2D</a>({ (tx - 0.5) * s_x, (ty - 0.5) * s_y }) + jitter + <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#a57d93ce8b44133ed956acc10a45e6223">spawnCentre</a>;</div><div class="line"></div><div class="line">            <span class="comment">// wash::Particle newp = wash::Particle();</span></div><div class="line">            <span class="comment">// newp.set_force_vector(&quot;position&quot;, newp.get_pos());</span></div><div class="line">            <span class="comment">// newp.set_vel(initialVelocity);</span></div><div class="line">            <span class="comment">// // VelocityUpdate(newp); // call here as the first initial call before density kernel</span></div><div class="line">            <span class="comment">// wash::add_par(newp);</span></div><div class="line">            <span class="keyword">auto</span>&amp; p = wash::create_particle(0.0, 1.0, <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#aeb9760a781fb6ccf134ed4353c9888e5">smoothingRadius</a>, pos, <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#ab15a76f258cadefcad1f4b39a8e76618">initialVelocity</a>);</div><div class="line">            p.set_force_vector(<span class="stringliteral">&quot;position&quot;</span>, pos);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (i &lt; 5) {</div><div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;Particle &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; position &quot;</span> &lt;&lt; pos &lt;&lt; std::endl;</div><div class="line">            }</div><div class="line"></div><div class="line">            i++;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h2>Force and Update Kernels</h2>
<p>These kernels define how particles change. The registration order of these kernels is order-sensitive, meaning they are run (at each iteration) in the order specified. Here's how we will order our force kernels: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div><div class="line">    ...</div><div class="line">    <a class="code" href="namespacewash.html#abc27c958fb1156da77a1346c3559abc1">wash::add_update_kernel</a>(&amp;VelocityUpdate);</div><div class="line">    <a class="code" href="namespacewash.html#a2ffa21a9e32d3ca6ce87def3e7db4837">wash::add_force_kernel</a>(&amp;CalculateDensity);</div><div class="line">    <a class="code" href="namespacewash.html#a2ffa21a9e32d3ca6ce87def3e7db4837">wash::add_force_kernel</a>(&amp;force_kernel);</div><div class="line"></div><div class="line">    <a class="code" href="namespacewash.html#abc27c958fb1156da77a1346c3559abc1">wash::add_update_kernel</a>(&amp;UpdatePositions);</div><div class="line">    <a class="code" href="namespacewash.html#abc27c958fb1156da77a1346c3559abc1">wash::add_update_kernel</a>(&amp;HandleCollisions);</div><div class="line"></div><div class="line">    <a class="code" href="namespacewash.html#a4c8a9913a535b341da9e72826916544b">wash::start</a>();</div><div class="line">}</div></div><!-- fragment --><p> This is the last part of our Main function. It describes the high-level behaviour of the simulation, and all that's left is the low-level specification of what should happen in each kernel.</p>
<p>Notice that the kernels are to be specified for <em>one</em> particle. WaSH will take care of the looping and parallelisation.</p>
<h3>VelocityUpdate Implementation</h3>
<p>This kernel function helps us predict where the particle will be in the next timestep. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> VelocityUpdate(<a class="code" href="classwash_1_1Particle.html">wash::Particle</a>&amp; particle) {</div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a4755365883cfd62117ebe74fe44d35e0">set_vel</a>(particle.<a class="code" href="classwash_1_1Particle.html#a890d0f1467225393e385872b0c98b974">get_vel</a>() + <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#a96532193226b3cbb236e6465defeb469">ExternelForces</a>(particle.<a class="code" href="classwash_1_1Particle.html#a9d222d453d640cf629ee8dfbee6b43c2">get_pos</a>(), particle.<a class="code" href="classwash_1_1Particle.html#a890d0f1467225393e385872b0c98b974">get_vel</a>()) * <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a78e0adba8d27825f587ec87ed578015f">deltaTime</a>);</div><div class="line">    <span class="comment">// std::cout &lt;&lt; &quot;Particle velocity: &quot; &lt;&lt; particle.get_vel() &lt;&lt; std::endl;</span></div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> predictionFactor = 1 / 120.0;</div><div class="line">    <span class="comment">// set predicted pos to the real position + some timestep of current vel</span></div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#af06835533935c04e594c258a7dcdd1ef">set_pos</a>(particle.<a class="code" href="classwash_1_1Particle.html#a9c6ec5d5a7407897ecca00549bd05c01">get_force_vector</a>(<span class="stringliteral">&quot;position&quot;</span>) + particle.<a class="code" href="classwash_1_1Particle.html#a890d0f1467225393e385872b0c98b974">get_vel</a>() * predictionFactor);</div><div class="line">    <span class="comment">// std::cout &lt;&lt; &quot;Particle pred pos: &quot; &lt;&lt; particle.get_pos() &lt;&lt; std::endl;</span></div><div class="line">}</div></div><!-- fragment --><h3>CalculateDensity Implementation</h3>
<p>Calculating density of particles is common across most, if not all, SPH simulations. Here's how we'll define it for our example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> CalculateDensity(<a class="code" href="classwash_1_1Particle.html">wash::Particle</a>&amp; particle, <span class="keyword">const</span> std::vector&lt;wash::Particle&gt;&amp; neighbours) {</div><div class="line">    <span class="comment">// std::cout &lt;&lt; &quot;Running Custom Density Func&quot; &lt;&lt; std::endl;</span></div><div class="line">    <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a140d94d7edb97c062961056d1926a2db">density</a> = 1.0;</div><div class="line">    <span class="keywordtype">double</span> nearDensity = 1.0;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; neighbour : neighbours) {</div><div class="line">        <span class="keyword">auto</span> offset = neighbour.get_pos() - particle.<a class="code" href="classwash_1_1Particle.html#a9d222d453d640cf629ee8dfbee6b43c2">get_pos</a>();</div><div class="line">        <span class="keywordtype">double</span> dst = offset.<a class="code" href="classwash_1_1Vec.html#a41de499daf12160b2cf515ce0c9da70f">magnitude</a>();</div><div class="line"></div><div class="line">        <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a140d94d7edb97c062961056d1926a2db">density</a> += <a class="code" href="flsim__kernels_8hpp.html#aa2b224ec4324bc9df6dc05231b0fb1f4">DensityKernel</a>(dst, <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#aeb9760a781fb6ccf134ed4353c9888e5">smoothingRadius</a>);</div><div class="line">        nearDensity += <a class="code" href="flsim__kernels_8hpp.html#a24021cba59575fe555fcd996328dfad9">NearDensityKernel</a>(dst, <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#aeb9760a781fb6ccf134ed4353c9888e5">smoothingRadius</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a6416678dd509c16c2933d315b6ae6156">set_density</a>(<a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a140d94d7edb97c062961056d1926a2db">density</a>);</div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a2c3038c8eac34e371922bcf1ab79b8ca">set_force_scalar</a>(<span class="stringliteral">&quot;nearDensity&quot;</span>, nearDensity);</div><div class="line">}</div></div><!-- fragment --><h3>force_kernel Implementation</h3>
<p>Here, forces are applied to particles to simulate incompressible fluid with some viscosity. In this case, we want something resembling water. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> force_kernel(<a class="code" href="classwash_1_1Particle.html">wash::Particle</a>&amp; particle, <span class="keyword">const</span> std::vector&lt;wash::Particle&gt;&amp; neighbours) {</div><div class="line">    CalculatePressureForce(particle, neighbours);</div><div class="line">    CalculateViscosity(particle, neighbours);</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line"><span class="keywordtype">void</span> CalculatePressureForce(<a class="code" href="classwash_1_1Particle.html">wash::Particle</a>&amp; particle, <span class="keyword">const</span> std::vector&lt;wash::Particle&gt;&amp; neighbours) {</div><div class="line">    <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a140d94d7edb97c062961056d1926a2db">density</a> = particle.<a class="code" href="classwash_1_1Particle.html#a8c0ce3f48b189fd8550c3bfab17eec68">get_density</a>();</div><div class="line">    <span class="keywordtype">double</span> nearDensity = particle.<a class="code" href="classwash_1_1Particle.html#ab42a162b41a4e8cf6212bd9c43f3a0cf">get_force_scalar</a>(<span class="stringliteral">&quot;nearDensity&quot;</span>);</div><div class="line">    <span class="keywordtype">double</span> <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a35ac7259c74fa75da5dc982febe230c0">pressure</a> = <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#ae242b1d4df1d0d56aea2c284de9c52d5">PressureFromDensity</a>(<a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a140d94d7edb97c062961056d1926a2db">density</a>);</div><div class="line">    <span class="keywordtype">double</span> nearPressure = <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#a2d6d90830304d956a1b7880aafc425a3">NearPressureFromDensity</a>(nearDensity);</div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> pressureForce = <a class="code" href="namespacewash.html#a905f2d902fc7aaab0e8a58b6ee25baf1">wash::Vec2D</a>({0.0, 0.0});</div><div class="line"></div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> pos = particle.<a class="code" href="classwash_1_1Particle.html#a9d222d453d640cf629ee8dfbee6b43c2">get_pos</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; neighbour : neighbours) {</div><div class="line">        <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> neighbourPos = neighbour.get_pos();</div><div class="line">        <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> offsetToNeighbour = neighbourPos - pos;</div><div class="line">        <span class="keywordtype">double</span> dst = offsetToNeighbour.<a class="code" href="classwash_1_1Vec.html#a41de499daf12160b2cf515ce0c9da70f">magnitude</a>();</div><div class="line"></div><div class="line">        <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> dirToNeighbour = dst &gt; 0.0 ? offsetToNeighbour / dst : <a class="code" href="namespacewash.html#a905f2d902fc7aaab0e8a58b6ee25baf1">wash::Vec2D</a>({0.0, 1.0});</div><div class="line"></div><div class="line">        <span class="keywordtype">double</span> neighbourDensity = neighbour.get_density();</div><div class="line">        <span class="keywordtype">double</span> neighbourNearDensity = neighbour.get_force_scalar(<span class="stringliteral">&quot;nearDensity&quot;</span>);</div><div class="line">        <span class="keywordtype">double</span> neighbourPressure = <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#ae242b1d4df1d0d56aea2c284de9c52d5">PressureFromDensity</a>(neighbourDensity);</div><div class="line">        <span class="keywordtype">double</span> neighbourNearPressure = <a class="code" href="ca__fluid__sim_2fluid__sim_8cpp.html#a2d6d90830304d956a1b7880aafc425a3">NearPressureFromDensity</a>(neighbourNearDensity);</div><div class="line"></div><div class="line">        <span class="keywordtype">double</span> sharedPressure = (<a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a35ac7259c74fa75da5dc982febe230c0">pressure</a> + neighbourPressure) * 0.5;</div><div class="line">        <span class="keywordtype">double</span> sharedNearPressure = (nearPressure + neighbourNearPressure) * 0.5;</div><div class="line"></div><div class="line">        pressureForce += dirToNeighbour * <a class="code" href="flsim__kernels_8hpp.html#a086696bc83d3db97c23fe6b4fbb6581c">DensityDerivative</a>(dst, <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#aeb9760a781fb6ccf134ed4353c9888e5">smoothingRadius</a>) * sharedPressure / neighbourDensity;</div><div class="line">        <span class="comment">// std::cout &lt;&lt; &quot;w density p &quot; &lt;&lt; pressureForce &lt;&lt; std::endl;</span></div><div class="line">        pressureForce +=</div><div class="line">            dirToNeighbour * <a class="code" href="flsim__kernels_8hpp.html#a2bf1a9071d088d903f6d511bb13c4e3e">NearDensityDerivative</a>(dst, <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#aeb9760a781fb6ccf134ed4353c9888e5">smoothingRadius</a>) * sharedNearPressure / neighbourNearDensity;</div><div class="line">        <span class="comment">// std::cout &lt;&lt; &quot;w near density p &quot; &lt;&lt; pressureForce &lt;&lt; std::endl;</span></div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> acceleration = pressureForce / <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a140d94d7edb97c062961056d1926a2db">density</a>;</div><div class="line">    <span class="comment">// std::cout &lt;&lt; &quot;PRESSURE FORCE p&quot; &lt;&lt; pressureForce &lt;&lt; std::endl;</span></div><div class="line"></div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a6960cdd169d1829a52e49cf835a8bfeb">set_force_vector</a>(<span class="stringliteral">&quot;pressure&quot;</span>, pressureForce / <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a140d94d7edb97c062961056d1926a2db">density</a>);</div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a4755365883cfd62117ebe74fe44d35e0">set_vel</a>(particle.<a class="code" href="classwash_1_1Particle.html#a890d0f1467225393e385872b0c98b974">get_vel</a>() + acceleration * <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a78e0adba8d27825f587ec87ed578015f">deltaTime</a>);</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line"><span class="keywordtype">void</span> CalculateViscosity(<a class="code" href="classwash_1_1Particle.html">wash::Particle</a>&amp; particle, <span class="keyword">const</span> std::vector&lt;wash::Particle&gt;&amp; neighbours) {</div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> pos = particle.<a class="code" href="classwash_1_1Particle.html#a9d222d453d640cf629ee8dfbee6b43c2">get_pos</a>();</div><div class="line"></div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> viscosityForce = <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> { 0.0, 0.0 };</div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> velocity = particle.<a class="code" href="classwash_1_1Particle.html#a890d0f1467225393e385872b0c98b974">get_vel</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; neighbour : neighbours) {</div><div class="line">        <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> neighbourPos = neighbour.get_pos();</div><div class="line">        <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> offsetToNeighbour = neighbourPos - pos;</div><div class="line">        <span class="keywordtype">double</span> dst = offsetToNeighbour.<a class="code" href="classwash_1_1Vec.html#a41de499daf12160b2cf515ce0c9da70f">magnitude</a>();</div><div class="line"></div><div class="line">        <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> neighbourVelocity = neighbour.get_vel();</div><div class="line">        viscosityForce += (neighbourVelocity - velocity) * <a class="code" href="flsim__kernels_8hpp.html#a5561095f423361bec442d282a4f8a47b">ViscosityKernel</a>(dst, <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#aeb9760a781fb6ccf134ed4353c9888e5">smoothingRadius</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a6960cdd169d1829a52e49cf835a8bfeb">set_force_vector</a>(<span class="stringliteral">&quot;viscosity&quot;</span>, viscosityForce * <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a0f2e430964cc73edbaf77b1e4eeb2136">viscosityStrength</a>);</div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a4755365883cfd62117ebe74fe44d35e0">set_vel</a>(particle.<a class="code" href="classwash_1_1Particle.html#a890d0f1467225393e385872b0c98b974">get_vel</a>() + viscosityForce * <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a0f2e430964cc73edbaf77b1e4eeb2136">viscosityStrength</a> * <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a78e0adba8d27825f587ec87ed578015f">deltaTime</a>);</div><div class="line">}</div></div><!-- fragment --><h3>UpdatePositions Implementation</h3>
<p>This one's pretty self-explanatory. Using basic SUVAT to update the particles' positions. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> UpdatePositions(<a class="code" href="classwash_1_1Particle.html">wash::Particle</a>&amp; particle) {</div><div class="line">    <span class="comment">// particle.set_pos(particle.get_pos() + particle.get_vel() * deltaTime);</span></div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a6960cdd169d1829a52e49cf835a8bfeb">set_force_vector</a>(<span class="stringliteral">&quot;position&quot;</span>, particle.<a class="code" href="classwash_1_1Particle.html#a9c6ec5d5a7407897ecca00549bd05c01">get_force_vector</a>(<span class="stringliteral">&quot;position&quot;</span>) + particle.<a class="code" href="classwash_1_1Particle.html#a890d0f1467225393e385872b0c98b974">get_vel</a>() * <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#a78e0adba8d27825f587ec87ed578015f">deltaTime</a>);</div><div class="line">}</div></div><!-- fragment --><h3>HandleCollisions Implementation</h3>
<p>The HandleCollisions kernel ensures particles do not exit the bounds of the simulation, and instead bounce back against a 'wall' (with a little damping) </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> HandleCollisions(<a class="code" href="classwash_1_1Particle.html">wash::Particle</a>&amp; particle) {</div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> pos = particle.<a class="code" href="classwash_1_1Particle.html#a9c6ec5d5a7407897ecca00549bd05c01">get_force_vector</a>(<span class="stringliteral">&quot;position&quot;</span>);</div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> vel = particle.<a class="code" href="classwash_1_1Particle.html#a890d0f1467225393e385872b0c98b974">get_vel</a>();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> halfSize = <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#ae3c8d23dc2c71306f6366b252c3ffb18">boundsSize</a> * 0.5;</div><div class="line">    <a class="code" href="classwash_1_1Vec.html">wash::Vec2D</a> edgeDst = halfSize - pos.<a class="code" href="classwash_1_1Vec.html#aae15a1a2cea7e883e53c2e7f6164710a">abs</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (*(edgeDst[0]) &lt;= 0) {</div><div class="line">        *(pos[0]) = halfSize.<a class="code" href="classwash_1_1Vec.html#a1be26013b6d4f898b8504fc258043400">at</a>(0) * <a class="code" href="namespacewash.html#a706d6d30508a81b6b9f25494cd759dff">wash::sgn</a>(pos.<a class="code" href="classwash_1_1Vec.html#a1be26013b6d4f898b8504fc258043400">at</a>(0));</div><div class="line">        *(vel[0]) *= -1 * <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#ab103ceb8127270461e6653cc3a770182">collisionDamping</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (*(edgeDst[1]) &lt;= 0) {</div><div class="line">        *(pos[1]) = halfSize.<a class="code" href="classwash_1_1Vec.html#a1be26013b6d4f898b8504fc258043400">at</a>(1) * <a class="code" href="namespacewash.html#a706d6d30508a81b6b9f25494cd759dff">wash::sgn</a>(pos.<a class="code" href="classwash_1_1Vec.html#a1be26013b6d4f898b8504fc258043400">at</a>(1));</div><div class="line">        *(vel[1]) *= -1 * <a class="code" href="3d__fluid__sim_2fluid__sim_8cpp.html#ab103ceb8127270461e6653cc3a770182">collisionDamping</a>;</div><div class="line">    }</div><div class="line">    <span class="comment">// do any obstacle collision here</span></div><div class="line"></div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a6960cdd169d1829a52e49cf835a8bfeb">set_force_vector</a>(<span class="stringliteral">&quot;position&quot;</span>, pos);</div><div class="line">    particle.<a class="code" href="classwash_1_1Particle.html#a4755365883cfd62117ebe74fe44d35e0">set_vel</a>(vel);</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
